import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useMemo, useState } from "react";
import { Link } from "react-router-dom";
import { useQuery } from "@tanstack/react-query";
import api from "../../api/axios";
import { fetchProducts } from "../../api/products";
import { fetchAdminSalesSummary, fetchAdminSalesByWarehouse } from "../../api/purchases";
import { AdminTopNav } from "../../components/layout/AdminTopNav";
export default function AdminDashboard() {
    const managersQuery = useQuery({
        queryKey: ["admin", "managers"],
        queryFn: async () => {
            const response = await api.get("/auth/admin/managers");
            return response.data;
        }
    });
    const productsQuery = useQuery({
        queryKey: ["admin", "products"],
        queryFn: () => fetchProducts()
    });
    const salesSummaryQuery = useQuery({
        queryKey: ["admin", "sales-summary"],
        queryFn: fetchAdminSalesSummary
    });
    const salesSummary = salesSummaryQuery.data;
    const salesByWarehouseQuery = useQuery({
        queryKey: ["admin", "sales-by-warehouse"],
        queryFn: fetchAdminSalesByWarehouse
    });
    const warehouseSales = salesByWarehouseQuery.data ?? [];
    const products = productsQuery.data ?? [];
    const currencyFormatter = useMemo(() => new Intl.NumberFormat("en-IN", {
        style: "currency",
        currency: "INR"
    }), []);
    const [showLowStockModal, setShowLowStockModal] = useState(false);
    const [showOutOfStockModal, setShowOutOfStockModal] = useState(false);
    const [selectedManager, setSelectedManager] = useState(null);
    const [isLoadingManagerDetail, setIsLoadingManagerDetail] = useState(false);
    const [managerDetailError, setManagerDetailError] = useState(null);
    const { lowStockItems, outOfStockItems, totalInventoryValue } = useMemo(() => {
        const lowItems = products.filter((product) => product.currentStock > 0 && product.lowStock);
        const outItems = products.filter((product) => product.currentStock === 0);
        const totalValue = products.reduce((sum, product) => sum + (product.totalValue ?? 0), 0);
        return { lowStockItems: lowItems, outOfStockItems: outItems, totalInventoryValue: totalValue };
    }, [products]);
    const maxWarehouseRevenue = useMemo(() => {
        if (!warehouseSales.length) {
            return 0;
        }
        return Math.max(...warehouseSales.map((warehouse) => Number(warehouse.totalRevenue ?? 0)));
    }, [warehouseSales]);
    const lowStockCount = lowStockItems.length;
    const outOfStockCount = outOfStockItems.length;
    return (_jsxs("div", { className: "min-h-screen bg-ash", children: [_jsx(AdminTopNav, {}), _jsxs("main", { className: "mx-auto max-w-7xl px-10 py-8", children: [_jsxs("header", { className: "flex flex-col gap-3 md:flex-row md:items-end md:justify-between", children: [_jsxs("div", { children: [_jsx("h1", { className: "text-2xl font-semibold text-slate-800", children: "Admin Dashboard" }), _jsx("p", { className: "mt-1 text-sm text-slate-500", children: "Monitor managers and inventory performance across warehouses." })] }), _jsx(Link, { to: "/admin/sales", className: "inline-flex items-center justify-center rounded-md bg-midnight px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-900", children: "View Sales" })] }), _jsxs("section", { className: "mt-8 grid grid-cols-1 gap-6 md:grid-cols-3 xl:grid-cols-5", children: [_jsxs("div", { className: "rounded-xl bg-white p-6 shadow-md", children: [_jsx("p", { className: "text-xs font-semibold uppercase text-slate-500", children: "Total Products" }), _jsx("p", { className: "mt-4 text-3xl font-semibold text-slate-800", children: products.length })] }), _jsxs("div", { className: "rounded-xl bg-white p-6 shadow-md", children: [_jsx("p", { className: "text-xs font-semibold uppercase text-slate-500", children: "Inventory Value" }), _jsx("p", { className: "mt-4 text-3xl font-semibold text-slate-800", children: currencyFormatter.format(totalInventoryValue) })] }), _jsxs("button", { type: "button", onClick: () => setShowLowStockModal(true), className: "rounded-xl bg-white p-6 text-left shadow-md transition hover:-translate-y-1 hover:shadow-lg", children: [_jsx("p", { className: "text-xs font-semibold uppercase text-slate-500", children: "Low Stock Alerts" }), _jsx("p", { className: "mt-4 text-3xl font-semibold text-amber-600", children: lowStockCount }), _jsx("p", { className: "mt-2 text-xs text-slate-400", children: "Tap to view details" })] }), _jsxs("button", { type: "button", onClick: () => setShowOutOfStockModal(true), className: "rounded-xl bg-white p-6 text-left shadow-md transition hover:-translate-y-1 hover:shadow-lg", children: [_jsx("p", { className: "text-xs font-semibold uppercase text-slate-500", children: "Out of Stock" }), _jsx("p", { className: "mt-4 text-3xl font-semibold text-red-600", children: outOfStockCount }), _jsx("p", { className: "mt-2 text-xs text-slate-400", children: "Tap to view details" })] }), _jsxs("div", { className: "rounded-xl bg-white p-6 shadow-md", children: [_jsx("p", { className: "text-xs font-semibold uppercase text-slate-500", children: "Sales" }), salesSummaryQuery.isLoading ? (_jsx("p", { className: "mt-4 text-sm text-slate-500", children: "Loading..." })) : (_jsxs("div", { children: [_jsx("p", { className: "mt-4 text-3xl font-semibold text-slate-800", children: currencyFormatter.format(salesSummary?.totalRevenue ?? 0) }), _jsxs("p", { className: "mt-2 text-xs text-slate-400", children: [(salesSummary?.totalOrders ?? 0).toLocaleString(), " orders \u00B7 ", (salesSummary?.totalItems ?? 0).toLocaleString(), " items"] })] }))] })] }), _jsxs("section", { className: "mt-8 rounded-xl bg-white p-6 shadow-md", children: [_jsxs("div", { className: "flex items-center justify-between", children: [_jsxs("div", { children: [_jsx("h2", { className: "text-lg font-semibold text-slate-700", children: "Sales by Warehouse" }), _jsx("p", { className: "text-sm text-slate-500", children: "Visual snapshot of revenue contribution per store." })] }), _jsx(Link, { className: "text-sm font-semibold text-midnight", to: "/admin/sales", children: "See detailed report" })] }), salesByWarehouseQuery.isLoading ? (_jsx("p", { className: "mt-6 text-sm text-slate-500", children: "Loading chart..." })) : warehouseSales.length === 0 ? (_jsx("p", { className: "mt-6 text-sm text-slate-500", children: "No sales recorded yet." })) : (_jsx("div", { className: "mt-6 flex items-end gap-6 overflow-x-auto pb-4", children: warehouseSales.map((warehouse) => {
                                    const revenue = Number(warehouse.totalRevenue ?? 0);
                                    const height = maxWarehouseRevenue > 0 ? Math.max((revenue / maxWarehouseRevenue) * 220, 10) : 10;
                                    return (_jsxs("div", { className: "flex flex-col items-center gap-2 text-sm", children: [_jsx("div", { className: "flex h-56 w-12 items-end rounded-lg bg-sky-100", children: _jsx("div", { className: "w-full rounded-lg bg-midnight", style: { height: `${height}px` }, title: `${warehouse.warehouseName}: ${currencyFormatter.format(revenue)}` }) }), _jsxs("div", { className: "text-center", children: [_jsx("p", { className: "max-w-[4.5rem] truncate text-xs font-semibold text-slate-700", children: warehouse.warehouseName }), _jsxs("p", { className: "text-[10px] text-slate-400", children: [warehouse.totalItems, " items"] })] })] }, warehouse.warehouseId));
                                }) }))] }), _jsxs("section", { className: "mt-8 rounded-xl bg-white p-6 shadow-md", children: [_jsx("div", { className: "flex items-center justify-between", children: _jsxs("div", { children: [_jsx("h2", { className: "text-lg font-semibold text-slate-700", children: "Warehouse Managers" }), _jsx("p", { className: "text-sm text-slate-500", children: "Current roster of store leads." })] }) }), managersQuery.isLoading && _jsx("p", { children: "Loading managers..." }), managersQuery.isError && _jsx("p", { className: "text-red-500", children: "Failed to load managers." }), managersQuery.data && (_jsxs("table", { className: "mt-4 w-full table-auto text-left text-sm", children: [_jsx("thead", { children: _jsxs("tr", { className: "border-b bg-slate-50 text-xs uppercase tracking-widest text-slate-500", children: [_jsx("th", { className: "px-4 py-2", children: "Name" }), _jsx("th", { className: "px-4 py-2", children: "Email" }), _jsx("th", { className: "px-4 py-2", children: "Warehouse" }), _jsx("th", { className: "px-4 py-2", children: "Code" })] }) }), _jsx("tbody", { children: managersQuery.data.map((manager) => (_jsxs("tr", { className: "cursor-pointer border-b last:border-none transition hover:bg-slate-50", onClick: async () => {
                                                setManagerDetailError(null);
                                                setSelectedManager({ ...manager });
                                                setIsLoadingManagerDetail(true);
                                                try {
                                                    const response = await api.get(`/warehouses/manager/${manager.id}`);
                                                    setSelectedManager(response.data);
                                                }
                                                catch (error) {
                                                    const err = error;
                                                    setManagerDetailError(err.response?.data?.message ?? "Unable to load manager details");
                                                }
                                                finally {
                                                    setIsLoadingManagerDetail(false);
                                                }
                                            }, children: [_jsx("td", { className: "px-4 py-3 font-medium text-slate-800", children: manager.fullName }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: manager.email }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: manager.warehouseName ?? "--" }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: manager.warehouseCode ?? "--" })] }, manager.id))) })] }))] }), _jsxs("section", { className: "mt-8 rounded-xl bg-white p-6 shadow-md", children: [_jsxs("div", { className: "flex items-center justify-between", children: [_jsxs("div", { children: [_jsx("h2", { className: "text-lg font-semibold text-slate-700", children: "Inventory Overview" }), _jsx("p", { className: "text-sm text-slate-500", children: "All products and their warehouse assignments." })] }), _jsx(Link, { className: "text-sm font-semibold text-midnight", to: "/admin/inventory", children: "Manage Inventory" })] }), productsQuery.isLoading && _jsx("p", { className: "mt-4", children: "Loading products..." }), productsQuery.isError && _jsx("p", { className: "mt-4 text-red-500", children: "Failed to load products." }), products.length > 0 && (_jsx("div", { className: "mt-4 overflow-x-auto", children: _jsxs("table", { className: "w-full table-auto text-left text-sm", children: [_jsx("thead", { children: _jsxs("tr", { className: "border-b bg-slate-50 text-xs uppercase tracking-widest text-slate-500", children: [_jsx("th", { className: "px-4 py-2", children: "Product" }), _jsx("th", { className: "px-4 py-2", children: "SKU" }), _jsx("th", { className: "px-4 py-2", children: "Category" }), _jsx("th", { className: "px-4 py-2", children: "Vendor" }), _jsx("th", { className: "px-4 py-2", children: "Stock" }), _jsx("th", { className: "px-4 py-2", children: "Warehouse" })] }) }), _jsx("tbody", { children: products.slice(0, 10).map((product) => (_jsxs("tr", { className: "border-b last:border-none", children: [_jsx("td", { className: "px-4 py-3 font-medium text-slate-800", children: product.name }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: product.sku }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: product.category }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: product.vendor }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: product.currentStock }), _jsxs("td", { className: "px-4 py-3 text-slate-600", children: [product.warehouseName, _jsx("span", { className: "ml-2 text-xs text-slate-400", children: product.warehouseCode })] })] }, product.id))) })] }) })), products.length === 0 && !productsQuery.isLoading && (_jsx("p", { className: "mt-4 text-sm text-slate-500", children: "No products available yet." }))] })] }), showLowStockModal && (_jsx("div", { className: "fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 px-4", children: _jsxs("div", { className: "w-full max-w-3xl rounded-2xl bg-white p-6 shadow-2xl", children: [_jsxs("div", { className: "mb-4 flex items-center justify-between", children: [_jsxs("div", { children: [_jsx("h3", { className: "text-lg font-semibold text-slate-800", children: "Low Stock Products" }), _jsx("p", { className: "text-sm text-slate-500", children: "Items at or below reorder levels across warehouses." })] }), _jsx("button", { type: "button", className: "text-sm font-semibold text-slate-500 hover:text-slate-800", onClick: () => setShowLowStockModal(false), children: "Close" })] }), lowStockItems.length === 0 ? (_jsx("p", { className: "text-sm text-slate-500", children: "All products are healthy right now." })) : (_jsx("div", { className: "max-h-96 overflow-y-auto", children: _jsxs("table", { className: "w-full table-auto text-left text-sm", children: [_jsx("thead", { children: _jsxs("tr", { className: "border-b bg-slate-50 text-xs uppercase tracking-widest text-slate-500", children: [_jsx("th", { className: "px-4 py-2", children: "Product" }), _jsx("th", { className: "px-4 py-2", children: "SKU" }), _jsx("th", { className: "px-4 py-2", children: "Stock" }), _jsx("th", { className: "px-4 py-2", children: "Reorder Level" }), _jsx("th", { className: "px-4 py-2", children: "Warehouse" })] }) }), _jsx("tbody", { children: lowStockItems.map((product) => (_jsxs("tr", { className: "border-b last:border-none", children: [_jsx("td", { className: "px-4 py-3 font-medium text-slate-800", children: product.name }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: product.sku }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: product.currentStock }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: product.reorderLevel }), _jsxs("td", { className: "px-4 py-3 text-slate-600", children: [product.warehouseName, _jsx("span", { className: "ml-2 text-xs text-slate-400", children: product.warehouseCode })] })] }, product.id))) })] }) }))] }) })), showOutOfStockModal && (_jsx("div", { className: "fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 px-4", children: _jsxs("div", { className: "w-full max-w-3xl rounded-2xl bg-white p-6 shadow-2xl", children: [_jsxs("div", { className: "mb-4 flex items-center justify-between", children: [_jsxs("div", { children: [_jsx("h3", { className: "text-lg font-semibold text-slate-800", children: "Out of Stock Products" }), _jsx("p", { className: "text-sm text-slate-500", children: "Items that require immediate replenishment." })] }), _jsx("button", { type: "button", className: "text-sm font-semibold text-slate-500 hover:text-slate-800", onClick: () => setShowOutOfStockModal(false), children: "Close" })] }), outOfStockItems.length === 0 ? (_jsx("p", { className: "text-sm text-slate-500", children: "No products are fully out of stock." })) : (_jsx("div", { className: "max-h-96 overflow-y-auto", children: _jsxs("table", { className: "w-full table-auto text-left text-sm", children: [_jsx("thead", { children: _jsxs("tr", { className: "border-b bg-slate-50 text-xs uppercase tracking-widest text-slate-500", children: [_jsx("th", { className: "px-4 py-2", children: "Product" }), _jsx("th", { className: "px-4 py-2", children: "SKU" }), _jsx("th", { className: "px-4 py-2", children: "Category" }), _jsx("th", { className: "px-4 py-2", children: "Warehouse" })] }) }), _jsx("tbody", { children: outOfStockItems.map((product) => (_jsxs("tr", { className: "border-b last:border-none", children: [_jsx("td", { className: "px-4 py-3 font-medium text-slate-800", children: product.name }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: product.sku }), _jsx("td", { className: "px-4 py-3 text-slate-600", children: product.category }), _jsxs("td", { className: "px-4 py-3 text-slate-600", children: [product.warehouseName, _jsx("span", { className: "ml-2 text-xs text-slate-400", children: product.warehouseCode })] })] }, product.id))) })] }) }))] }) })), selectedManager && (_jsx("div", { className: "fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 px-4", children: _jsxs("div", { className: "w-full max-w-xl rounded-2xl bg-white p-6 shadow-2xl", children: [_jsxs("div", { className: "mb-4 flex items-center justify-between", children: [_jsxs("div", { children: [_jsx("h3", { className: "text-lg font-semibold text-slate-800", children: "Store Details" }), _jsxs("p", { className: "text-sm text-slate-500", children: ["Manager: ", selectedManager.fullName] })] }), _jsx("button", { type: "button", className: "text-sm font-semibold text-slate-500 hover:text-slate-800", onClick: () => {
                                        setSelectedManager(null);
                                        setManagerDetailError(null);
                                    }, children: "Close" })] }), isLoadingManagerDetail ? (_jsx("p", { className: "text-sm text-slate-500", children: "Loading store insights..." })) : managerDetailError ? (_jsx("p", { className: "text-sm text-red-500", children: managerDetailError })) : (_jsxs("div", { className: "space-y-4", children: [_jsxs("div", { className: "rounded-lg bg-slate-50 p-4", children: [_jsx("p", { className: "text-xs font-semibold uppercase text-slate-500", children: "Warehouse" }), _jsx("p", { className: "mt-2 text-lg font-semibold text-slate-800", children: selectedManager.warehouseName ?? "--" }), _jsxs("p", { className: "text-sm text-slate-500", children: ["Code: ", selectedManager.warehouseCode ?? "--"] }), selectedManager.warehouseLocation && selectedManager.warehouseLocation !== selectedManager.warehouseCode && (_jsxs("p", { className: "text-sm text-slate-500", children: ["Location: ", selectedManager.warehouseLocation] }))] }), _jsxs("div", { className: "grid grid-cols-1 gap-4 md:grid-cols-3", children: [_jsxs("div", { className: "rounded-lg bg-white p-4 shadow-sm", children: [_jsx("p", { className: "text-xs font-semibold uppercase text-slate-500", children: "Total Products" }), _jsx("p", { className: "mt-2 text-xl font-semibold text-slate-800", children: selectedManager.totalProducts ?? 0 })] }), _jsxs("div", { className: "rounded-lg bg-white p-4 shadow-sm", children: [_jsx("p", { className: "text-xs font-semibold uppercase text-slate-500", children: "Inventory Value" }), _jsx("p", { className: "mt-2 text-xl font-semibold text-slate-800", children: currencyFormatter.format(selectedManager.totalValue ?? 0) })] }), _jsxs("div", { className: "rounded-lg bg-white p-4 shadow-sm", children: [_jsx("p", { className: "text-xs font-semibold uppercase text-slate-500", children: "Low Stock" }), _jsx("p", { className: "mt-2 text-xl font-semibold text-slate-800", children: selectedManager.lowStockCount ?? 0 })] })] })] }))] }) }))] }));
}
